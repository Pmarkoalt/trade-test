{% extends "base.html" %}

{% block content %}
<div class="email-wrapper">
    <div class="header">
        <h1>DAILY TRADING SIGNALS - {{ date }}</h1>
        <p class="subtitle">{{ num_recommendations }} New Recommendation{% if num_recommendations != 1 %}s{% endif %}</p>
    </div>

    <div class="section market-overview">
        <h2>ðŸ“Š MARKET OVERVIEW</h2>
        <p class="market-summary">
            {% if market %}
                {% if market.spy_price %}
                    SPY: ${{ "%.2f"|format(market.spy_price) }} ({{ "%+.2f"|format(market.spy_pct) }}%) |
                {% endif %}
                {% if market.btc_price %}
                    BTC: ${{ "%.2f"|format(market.btc_price) }} ({{ "%+.2f"|format(market.btc_pct) }}%)
                {% endif %}
                {% if market.regime %}
                    <br>Market Regime: {{ market.regime }}
                {% endif %}
            {% else %}
                Market data will be displayed here when available.
            {% endif %}
        </p>
    </div>

    {% if buy_signals %}
    <div class="section buy-signals">
        <h2>ðŸŽ¯ BUY SIGNALS</h2>
        {% for rec in buy_signals %}
            {{ formatter.format_recommendation_html(rec, loop.index) }}
        {% endfor %}
    </div>
    {% endif %}

    {% if sell_signals %}
    <div class="section sell-signals">
        <h2>ðŸ“‰ SELL SIGNALS</h2>
        {% for rec in sell_signals %}
            {{ formatter.format_recommendation_html(rec, loop.index) }}
        {% endfor %}
    </div>
    {% endif %}

    {% if portfolio and portfolio.positions %}
    <div class="section portfolio">
        <h2>ðŸ“ˆ CURRENT POSITIONS</h2>
        <table class="portfolio-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Entry</th>
                    <th>Current</th>
                    <th>P&L</th>
                    <th>Days</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in portfolio.positions %}
                <tr>
                    <td>{{ pos.symbol }}</td>
                    <td>${{ "%.2f"|format(pos.entry_price) }}</td>
                    <td>${{ "%.2f"|format(pos.current_price) }}</td>
                    <td class="{% if pos.pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                        {{ "%+.2f"|format(pos.pnl_pct) }}%
                    </td>
                    <td>{{ pos.days_held }}</td>
                    <td>{{ pos.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if news_analysis %}
    <div class="section news">
        <h2>ðŸ“° NEWS DIGEST</h2>
        
        <div class="market-sentiment">
            <h3>Market Sentiment: {{ news_analysis.market_sentiment_label.value | title }}</h3>
            <p>Based on {{ news_analysis.total_articles }} articles analyzed</p>
        </div>

        {% if positive_news %}
        <div class="news-section positive">
            <h4>ðŸŸ¢ Positive Sentiment</h4>
            <ul>
                {% for article in positive_news[:5] %}
                <li>
                    <strong>{{ article.symbols | join(', ') }}</strong>:
                    {{ article.title }}
                    <span class="source">({{ article.source }})</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if negative_news %}
        <div class="news-section negative">
            <h4>ðŸ”´ Negative Sentiment</h4>
            <ul>
                {% for article in negative_news[:5] %}
                <li>
                    <strong>{{ article.symbols | join(', ') }}</strong>:
                    {{ article.title }}
                    <span class="source">({{ article.source }})</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="news-section notable">
            <h4>ðŸ“Œ Notable Headlines</h4>
            <ul>
                {% for symbol, summary in news_analysis.symbol_summaries.items() %}
                    {% if summary.top_headlines %}
                    <li>
                        <strong>{{ symbol }}</strong>
                        ({{ summary.sentiment_label.value | title }}):
                        {{ summary.top_headlines[0] }}
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% elif news %}
    {# Fallback to old news format for backward compatibility #}
    <div class="section news">
        <h2>ðŸ“° NEWS DIGEST</h2>
        {% if news.positive %}
        <div class="news-section positive">
            <h4>ðŸŸ¢ POSITIVE SENTIMENT</h4>
            <ul>
                {% for item in news.positive %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if news.negative %}
        <div class="news-section negative">
            <h4>ðŸ”´ NEGATIVE SENTIMENT</h4>
            <ul>
                {% for item in news.negative %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if news.watch_list %}
        <div class="news-section watch">
            <h4>ðŸŸ¡ WATCH LIST</h4>
            <ul>
                {% for item in news.watch_list %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if portfolio and portfolio.performance %}
    <div class="section performance">
        <h2>ðŸ“Š PERFORMANCE (MTD)</h2>
        <div class="performance-section">
            <p><strong>Strategy Return:</strong> {{ "%+.2f"|format(portfolio.performance.strategy_return) }}%</p>
            <p><strong>Benchmark (SPY):</strong> {{ "%+.2f"|format(portfolio.performance.benchmark_return) }}%</p>
            <p><strong>Alpha:</strong> {{ "%+.2f"|format(portfolio.performance.alpha) }}%</p>
            <p><strong>Win Rate:</strong> {{ "%.0f"|format(portfolio.performance.win_rate) }}%</p>
            <p><strong>Avg Winner:</strong> {{ "%+.2f"|format(portfolio.performance.avg_winner) }}%</p>
            <p><strong>Avg Loser:</strong> {{ "%+.2f"|format(portfolio.performance.avg_loser) }}%</p>
        </div>
    </div>
    {% endif %}

    {% if performance %}
    {% include 'partials/performance_section.html' %}
    {% endif %}

    <div class="footer">
        <p>Generated by Trading Assistant v1.0</p>
        <p>Generated at: {{ generated_at }}</p>
        <p><a href="#">View Dashboard</a> | <a href="#">Unsubscribe</a></p>
    </div>
</div>
{% endblock %}

